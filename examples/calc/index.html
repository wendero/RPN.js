<!doctype html>
<html lang="en-US">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>RPN.js | Calculator</title>
    <script type="text/javascript" src="../../src/rpn.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <link rel="stylesheet" href="style.css" />
</head>

<body>
    <div class="calculator">
        <div class="display">
            <div class="line1"></div>
            <div class="stack">

            </div>
        </div>
        <div class="info">
            <span id="f2nd">2nd</span>
        </div>
        <div class="keyboard">
            <table>
                <tr class="functions">
                    <td>
                        <table>
                            <tr>
                                <td>.</td>
                                <td>.</td>
                                <td>.</td>
                                <td>.</td>
                                <td>.</td>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td>
                        <table class="keys">
                            <tr>
                                <td>.</td>
                                <td>.</td>
                                <td>.</td>
                                <td>.</td>
                                <td>.</td>
                            </tr>
                            <tr>
                                <td>.</td>
                                <td>.</td>
                                <td>.</td>
                                <td>.</td>
                                <td>.</td>
                            </tr>
                            <tr>
                                <td>.</td>
                                <td>.</td>
                                <td>.</td>
                                <td>.</td>
                                <td>.</td>
                            </tr>
                            <tr>
                                <td keys="s" data-rpn="sum">&sum;
                                    <span class="ctrl" data-rpn="sumk" keys="ctrl+s">&sum;
                                        <sub>k</sub>
                                    </span>
                                </td>
                                <td>.
                                </td>
                                <td></td>
                                <td>.</td>
                                <td>.</td>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td>
                        <table class="keys">
                            <tr>
                                <td>.</td>
                                <td keys="%" data-rpn="%">&percnt;
                                    <span class="ctrl" keys="ctrl+%" data-rpn="perc">&Delta;&percnt;</span>
                                </td>
                                <td keys="/" data-rpn="/">&divide;
                                    <span class="ctrl" keys="ctrl+/" data-rpn="mod">Mod</span>
                                </td>
                                <td keys="*" data-rpn="*">&times;</td>
                                <td keys="-" data-rpn="-">&minus;
                                    <span class="ctrl" keys="ctrl+-" data-rpn="+-">&PlusMinus;</span>
                                </td>
                            </tr>
                            <tr>
                                <td class="control-key">&UpTeeArrow;</td>
                                <td keys="7" data-rpn="7" data-type="value">7</td>
                                <td keys="8" data-rpn="8" data-type="value">8</td>
                                <td keys="9" data-rpn="9" data-type="value">9</td>
                                <td keys="+" data-rpn="+" rowspan="2">&plus;</td>
                            </tr>
                            <tr>
                                <td>.</td>
                                <td keys="4" data-rpn="4" data-type="value">4</td>
                                <td keys="5" data-rpn="5" data-type="value">5</td>
                                <td keys="6" data-rpn="6" data-type="value">6</td>
                            </tr>
                            <tr>
                                <td keys="delete" data-rpn="pop">Del</td>
                                <td keys="1" data-rpn="1" data-type="value">1</td>
                                <td keys="2" data-rpn="2" data-type="value">2</td>
                                <td keys="3" data-rpn="3" data-type="value">3</td>
                                <td keys="enter" data-rpn="enter" rowspan="2" class="font-2x">&hookleftarrow;</td>
                            </tr>
                            <tr>
                                <td keys="delete" data-rpn="pop">Del
                                    <span class="ctrl" keys="ctrl+delete escape" data-rpn="clr">Clr</span>
                                </td>
                                <td keys="0" data-rpn="0" data-type="value">0</td>
                                <td keys="x" data-rpn="E">E</td>
                                <td keys=". ," data-rpn=".">.</td>
                            </tr>
                        </table>
                    </td>
                </tr>
            </table>
        </div>
    </div>
    <script>
        $(document).ready(() => {
            var stack = [];
            var val = "";
            var rpn = "";

            $(document).on('keyup', null, (ev) => {
                if (ev.key == "Control") {
                    ControlKey(false);
                }
            })

            $(document).on('keydown', null, (ev) => {

                if (ev.key == "Control" || ev.ctrlKey) {
                    ev.stopPropagation();
                    ev.stopImmediatePropagation();
                    ev.preventDefault();

                    ControlKey(true);
                }
                var ctrl = ev.ctrlKey ? 'ctrl+' : '';
                var key = $(`*[keys~='${ctrl}${ev.key.toString().toLowerCase()}']`);

                key.click();
            })
            $("table.keys td").click((ev) => {
                var $target = $(ev.target);
                var rpn = $target.data("rpn");
                if (rpn == null)
                    return;

                var isVal = $target.data("type") && $target.data("type") == "value";
                if (isVal) {
                    AddVal(rpn);
                } else if (rpn == ".") {
                    if (!val.endsWith(".")) {
                        AddVal(rpn);
                    }
                } else if (rpn == "%") {
                    AddVal(rpn);
                    AddStack();
                    Evaluate();
                } else if (rpn == "-" && val == '') {
                    AddVal(rpn);
                } else if (rpn == "+-" && val != '') {
                    val = val * -1;
                    $('.line1').text(val);
                } else if (rpn == "enter") {
                    if (val == "-") {
                        AddStack();
                        Evaluate();
                    } else {
                        AddStack();
                    }
                } else {
                    if (val != '') {
                        AddStack();
                    }
                    stack.push(rpn);
                    Evaluate();
                }
            });

            function AddStack() {
                if (val == '')
                    return;
                stack.push(val);
                AddIntoDisplay(val);
                val = '';
            }

            function AddIntoDisplay(value) {
                let $div = $(`<div>${value}</div>`);
                $div.prependTo($('.stack'));
                $('.line1').text('');
            }

            function AddVal(value) {
                val += value;
                $('.line1').text(val);
            }

            function Evaluate() {
                stack = RPN.Single(stack.join(' '));
                $('.stack').text('');

                stack.forEach(element => {
                    AddIntoDisplay(element);
                });
            }

            function ControlKey(pressed) {
                if (pressed) {
                    $('#function').text('2nd');
                    $('.calculator').addClass("ctrl");
                } else {
                    $('#function').text('normal');
                    $('.calculator').removeClass("ctrl");
                }
            }
        });
    </script>
</body>

</html>